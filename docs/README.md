# ソフトウェア要件定義書

## 1. 概要

### 1.1 目的
本ソフトウェアは、ダイヤゼブラ電機製 太陽光発電・蓄電システム「EIBS7」を ECHONET Lite プロトコルを用いて監視・制御することを目的とする。

### 1.2 動作環境
- Raspberry Pi または Linux サーバー上で 24時間365日稼働する。

### 1.3 開発環境
- macOS

### 1.4 成果物
- 単一ファイルのネイティブバイナリ

### 1.5 通信プロトコル
- ECHONET Lite (トランスポート層: UDP)

## 2. 対象機器

### 2.1 機種名
- ダイヤゼブラ電機 EIBS7

### 2.2 ECHONET Lite オブジェクト
本ソフトウェアが通信対象とする EIBS7 内の ECHONET Lite 機器オブジェクトは以下の通り。インスタンスコードはすべて `01` とする。

- 住宅用太陽光発電 (クラスコード: `0x0279`, インスタンスコード: `01`, EOJ: `027901`)
- 蓄電池 (クラスコード: `0x027D`, インスタンスコード: `01`, EOJ: `027D01`)
- 分電盤メータリング (クラスコード: `0x0287`, インスタンスコード: `01`, EOJ: `028701`)
- マルチ入力PCS (クラスコード: `0x02A5`, インスタンスコード: `01`, EOJ: `02A501`)

### 2.3 ネットワーク特定方法
- EIBS7 には固定 IP アドレスを割り当てる。
- IP アドレスは設定ファイルにて管理する。

## 3. 機能要件

### 3.1 監視機能

#### 3.1.1 定期的なデータ取得
- 設定ファイルで指定された間隔（デフォルト: 10秒）で、以下の監視項目のプロパティ値を取得する。

#### 3.1.2 監視項目 (直接取得)

| オブジェクト (EOJ)       | プロパティ名                 | EPC    | データ型/単位        | 備考                             |
| :----------------------- | :--------------------------- | :----- | :------------------- | :------------------------------- |
| 蓄電池 (`027D01`)        | 瞬時充放電電力計測値         | `0xD3` | signed long (W)      | 正:充電, 負:放電                 |
| 蓄電池 (`027D01`)        | AC実効容量（充電）           | `0xA0` | unsigned long (Wh)   | 満充電時の容量                   |
| 蓄電池 (`027D01`)        | 蓄電残量3                    | `0xE4` | unsigned char (%)    |                                  |
| 住宅用太陽光発電 (`027901`) | 瞬時発電電力計測値           | `0xE0` | unsigned short (W)   |                                  |
| 分電盤メータリング (`028701`) | 瞬時電力計測値               | `0xC6` | signed long (W)      | |
| マルチ入力PCS (`02A501`)   | 瞬時電力計測値               | `0xE7` | signed long (W)      | |

#### 3.1.3 監視項目 (計算値)

- **自家消費電力 (W):**
  `自家消費電力 = 分電盤メータリング.瞬時電力計測値(0xC6) - マルチ入力PCS.瞬時電力計測値(0xE7)`
- **余剰電力 (W):**
  `余剰電力 = 太陽光発電.瞬時発電電力計測値(0xE0) - 自家消費電力`

### 3.2 制御機能

#### 3.2.1 制御対象
- 蓄電池 (EOJ: `027D01`)

#### 3.2.2 制御項目

| プロパティ名         | EPC    | データ型/値                               | 備考                                 |
| :------------------- | :----- | :---------------------------------------- | :----------------------------------- |
| 運転モード設定       | `0xDA` | unsigned char (`0x46`:自動, `0x42`:充電) | 他の値も存在するが、本システムでは主にこれらを使用 |
| 充電電力設定値       | `0xEB` | unsigned long (W)                         | 上限値: 5430W                        |

#### 3.2.3 制御ロジック

**1. 充電時間帯の定義**
- **方法1 (必須):** 設定ファイルで指定された固定の開始時刻と終了時刻で定義される時間帯。
- **方法2 (任意):** 太陽高度・方位角計算による推定。本バージョンでは実装必須ではない。

**2. 充電時間帯における制御**
   - **基本動作:** 運転モードを「充電 (`0xDA` = `0x42`)」に設定し、以下の充電電力制御を行う。ただし、後述の「買電抑制制御」が優先される場合を除く。
   - **充電電力計算:**
     1. 目標充電量 (Wh) = `AC実効容量(0xA0) * (1.0 - 蓄電残量3(0xE4) / 100.0)`
     2. 残り時間 (分) = 充電終了時刻 - 現在時刻
     3. 目標充電電力 (W) = 目標充電量(Wh) * 60 / 残り時間(分) （ただし上限は 3000W と 余剰電力-500W の小さい方）
   - **充電電力設定:**
     - 計算された目標充電電力を「充電電力設定値 (`0xEB`)」として設定する。
     - 充電電力設定値の**引き上げ**が必要な場合（目標値が現在設定値より大きい場合）は、設定ファイルで指定された間隔（デフォルト: 10分）で行う。

**3. 買電抑制制御（充電時間帯における優先ロジック）**
   - 余剰電力を計算する（3.1.3参照）。
   - **自動モードへの切替:**
     - もし `余剰電力 < 自動切替閾値` (設定値) ならば：
       - 運転モードを「自動 (`0xDA` = `0x46`)」に設定する。
       - 充電電力設定値 (`0xEB`) の**引き下げ**が必要な場合（目標値が現在設定値より小さい場合）は、監視周期ごと（即時）に再計算・再設定する。
   - **充電モードへの復帰:**
     - もし `余剰電力 >= 充電切替閾値` (設定値, 自動切替閾値より大きい) ならば：
       - 運転モードを「充電 (`0xDA` = `0x42`)」に設定する（上記「基本動作」に戻る）。

**4. 充電時間帯以外の制御**
   - 運転モードを「自動 (`0xDA` = `0x46`)」に設定する。

**5. 安全性: モード変更頻度抑制（チャタリング防止）**
   - 運転モードを「充電」から「自動」に切り替えた場合、設定ファイルで指定された時間（デフォルト: 5分）は「自動」モードを維持し、その間は「充電」モードへの再切り替えを行わない。

### 3.3 通信処理
- ECHONET Lite フレーム (EHD, TID, SEOJ, DEOJ, ESV, OPC, EPC, PDC, EDT) の構築。
- UDP によるフレーム送受信。
- 送信フレームごとにユニークな TID (Transaction ID) を付与し、応答フレームの TID を確認する。
- 応答タイムアウト処理（タイムアウトした場合はエラーとしてログ記録）。
- エラー応答処理（ESV が `0x5x` など）を検知し、エラーとしてログ記録。

## 4. 非機能要件

### 4.1 ログ出力
- 以下の情報を syslog に出力する。syslog の設定（ファシリティ、レベル等）は設定ファイルで指定可能とする。
  - 取得した監視データ（設定により ON/OFF 可能）
  - 制御実行の記録（モード変更、充電電力設定など）
  - 通信エラー（タイムアウト、エラー応答など）
  - アプリケーションの起動・停止、内部エラー

### 4.2 設定管理
- 以下の項目を TOML または YAML 形式の設定ファイルで管理する。
  - EIBS7 の IP アドレス
  - 監視間隔 (秒)
  - Syslog 設定
  - 充電時間帯 (開始 HH:MM, 終了 HH:MM)
  * 充電電力上げ設定間隔 (分)
  * 自動切替閾値 (W)
  * 充電切替閾値 (W)
  * モード変更頻度抑制時間 (分)
  * (任意) 太陽高度計算に必要なパラメータ（緯度、経度、パネル方位角、傾斜角）
  * (任意) 監視データのログ出力 ON/OFF フラグ

### 4.3 UI (ユーザーインターフェース)
- 不要。

### 4.4 信頼性
- 24時間365日の連続稼働を前提とする。
- 通信エラー等が発生した場合でも、可能な限り処理を継続し、エラー情報をログに出力する。
- アプリケーションが異常終了した場合は、systemd 等の仕組みで自動再起動されることを想定する。

### 4.5 パフォーマンス
- 設定された監視間隔（デフォルト10秒）でのデータ取得、計算、制御判断、ログ出力が遅延なく完了すること。
- Raspberry Pi 3 または 4 相当の環境で、CPU 使用率やメモリ使用量が過剰にならないこと。

### 4.6 セキュリティ
- 設定ファイルには機密情報（例: 外部 API キーなど、将来的に追加される場合）が含まれる可能性があるため、ファイルパーミッションを適切に設定すること。
- ソフトウェアを実行するユーザー権限を最小限にすること。

## 5. その他

### 5.1 参照ドキュメント
- **EIBS7 ECHONET Lite 仕様:**
  - 搭載オブジェクト申告書: <https://echonet.jp/wp/wp-content/uploads/obj_prop/GZ/GZ-000764/Implemented_Objects.pdf>
  - 搭載プロパティ申告書（住宅用太陽光発電）: <https://echonet.jp/wp/wp-content/uploads/obj_prop/GZ/GZ-000764/Implemented_Properties_(0x027901).pdf>
  - 搭載プロパティ申告書（蓄電池）: <https://echonet.jp/wp/wp-content/uploads/obj_prop/GZ/GZ-000764/Implemented_Properties_(0x027D01).pdf>
  - 搭載プロパティ申告書（分電盤メータリング）: <https://echonet.jp/wp/wp-content/uploads/obj_prop/GZ/GZ-000764/Implemented_Properties_(0x028701).pdf>
  - 搭載プロパティ申告書（マルチ入力PCS）: <https://echonet.jp/wp/wp-content/uploads/obj_prop/GZ/GZ-000764/Implemented_Properties_(0x02A501).pdf>
- **ECHONET Lite 仕様書:**
  - ECHONET Lite 通信ミドルウェア仕様 Ver.1.14: <https://echonet.jp/wp/wp-content/uploads/pdf/General/Standard/ECHONET_lite_V1_14_jp/ECHONET-Lite_Ver.1.14(02).pdf>
  - ECHONET 機器オブジェクト詳細規定 Appendix Release R.r3: <https://echonet.jp/wp/wp-content/uploads/pdf/General/Standard/Release/Release_R/Appendix_Release_R_r3.pdf>